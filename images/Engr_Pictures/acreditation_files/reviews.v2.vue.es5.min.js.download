"use strict";$(function(){Vue.component("reviewItem",{props:["review"],data:function(){return{}},template:$("#reviewItemTemplate").text(),methods:{toDate:function(n){return typeof n=="string"?new Date(n):n},upvote:function(n){this.$emit("upvote",n)},downvote:function(n){this.$emit("downvote",n)},report:function(n){this.$emit("report",n)},fancyPop:function(n){this.$root.fancyPop(n)}}});new Vue({el:"#LPPEReviewNGAPP",name:"ProductReviews",data:{sort:"DATE DESC",hasMore:!0,isLoadingMore:!1,current_index:6,reviews_per_screen:6,reviews:reviews_bootstrap.reviews,showPageBoundReviews:!0,showReviewForm:!1,filter:null,submitted:!1,submitting:!1,total_reviews:reviews_bootstrap.total_reviews,newReview:{user_nickname:"",rating_overall:0,review_text:"",review_title:"",recommended:null,captcha_hash:"",image1:"data:image/gif;base64,R0lGODlhEAAQAIABAN3d3QAAACH5BAEAAAEALAAAAAAQABAAAAIlhI9pwe2+nmQRAllbpvft8IWdgnAcOXYWpmqt6b2gLE7TZ6N6AQA7",image2:"data:image/gif;base64,R0lGODlhEAAQAIABAN3d3QAAACH5BAEAAAEALAAAAAAQABAAAAIlhI9pwe2+nmQRAllbpvft8IWdgnAcOXYWpmqt6b2gLE7TZ6N6AQA7",image3:"data:image/gif;base64,R0lGODlhEAAQAIABAN3d3QAAACH5BAEAAAEALAAAAAAQABAAAAIlhI9pwe2+nmQRAllbpvft8IWdgnAcOXYWpmqt6b2gLE7TZ6N6AQA7"},errors:[],hCaptchaInjected:!1},methods:{SubmitReview:function(){var n=this;if(this.errors=[],this.newReview.user_nickname||this.errors.push("Please enter your name or nickname."),this.newReview.rating_overall||this.errors.push("Please rate the product overall"),this.newReview.review_text||this.errors.push("Please enter a title for the review."),this.newReview.review_text.length<10&&this.errors.push("Please enter at least 10 characters -- it should be helpful to others!"),this.errors.length)return!1;if(this.newReview.captcha_hash=window.hcaptcha.getResponse(),!this.newReview.captcha_hash&&location.host.indexOf("local")!==0){alert("Please confirm you are not a robot");return}this.newReview.image1===this.IMAGE_ADD_ICON&&(this.newReview.image1="");this.newReview.image2===this.IMAGE_ADD_ICON&&(this.newReview.image2="");this.newReview.image3===this.IMAGE_ADD_ICON&&(this.newReview.image3="");n.submitting=!0;$.post("/ajax/reviews.ashx",Object.assign({action:"createreview",product_id:window.prx_pid||window.prx_id},this.newReview)).then(function(t){t.success?(n.submitted=!0,n.showReviewForm=!1,window.location.hash="#LPPEReviewNGAPP",window.GAMethods&&window.GAMethods.trackCustomEvent&&window.GAMethods.trackCustomEvent("product_page_details",{click_location:"Submit Review"}),this.filter=null,n.ResetReviews()):(t.message&&(alert(t.message),window.Raven&&window.Raven.captureException&&window.Raven.captureException(new Error(t.message))),n.newReview.image1=n.newReview.image1||n.IMAGE_ADD_ICON.toString(),n.newReview.image2=n.newReview.image2||n.IMAGE_ADD_ICON.toString(),n.newReview.image3=n.newReview.image3||n.IMAGE_ADD_ICON.toString(),n.newReview.captcha_hash="");n.submitting=!1;window.hcaptcha.reset()})},ResetReviews:function(){var n=this;this.showPageBoundReviews=!1;this.isLoadingMore=!0;this.hasMore=!0;this.current_index=0;this.GetReviews(window.prx_pid,this.current_index,this.reviews_per_screen,this.sort,this.filter).then(function(t){n.reviews=t;n.current_index=t.length;t.length<n.reviews_per_screen&&(n.hasMore=!1);n.isLoadingMore=!1})},LoadMore:function(){var n=this,i,t;if(this.isLoadingMore=!0,this.hidden_reviews.length){for(i=Math.min(n.reviews_per_screen,n.hidden_reviews.length),t=0;t<n.reviews.length;t++)t+1<=i+n.current_index&&(n.reviews[t].hide_review=!1);n.current_index+=i;this.isLoadingMore=!1;return}this.GetReviews(window.prx_pid,this.current_index,this.reviews_per_screen,this.sort,this.filter).then(function(t){t.length<n.reviews_per_screen&&(n.hasMore=!1);for(var i=0;i<t.length;i++)n.reviews.push(t[i]);n.current_index=n.reviews.length;n.isLoadingMore=!1});window.GAMethods&&window.GAMethods.trackCustomEvent&&window.GAMethods.trackCustomEvent("product_page_details",{click_location:"Load More Reviews"})},doCloseParentModal:function(){return window.parent&&window.parent.PRX_Utils&&window.parent.PRX_Utils.closeOpenAlertModal()},setFilter:function(n){this.filter=this.filter==n?null:n;this.ResetReviews()},GetReviews:function(n,t,i,r,u){var f=this;return $.getJSON("/ajax/reviews.ashx",{_:Date.now(),action:"getreviews",productid:n,start:t,count:i,sort:r,filter:u}).then(function(n){return f.total_reviews=n.total_reviews,n.result.length&&f.transformResults(n.result),n.result})},transformResults:function(n){for(var i,t=0;t<n.length;t++){for(Vue.set(n[t],"hide_review",!1),n[t].images=[],i=0;i<n[t].image_count;i++)n[t].images.push({large:"//cdn.petcarerx.com/reviews/"+n[t].id+"_"+i+".jpg",small:"//cdn.petcarerx.com/reviews/"+n[t].id+"_"+i+"_thumb.jpg"});n[t].pet_sentence=!!n[t].pet_life_stage&&!!n[t].pet_gender&&!!n[t].pet_breed&&!!n[t].pet_type?"This customer has an "+n[t].pet_life_stage+" "+n[t].pet_gender+" "+n[t].pet_breed+" ("+n[t].pet_type+")":null}},fancyPop:function(n){window.PRX_Utils&&PRX_Utils.doOpenImageModal(n)},upvote:function(n){typeof n=="number"&&(n=this.reviews[n]);n.voted=!0;n.upvotes++;$.post("/ajax/reviews.ashx",{action:"upvotereview",id:n.id})},downvote:function(n){typeof n=="number"&&(n=this.reviews[n]);confirm("Are you sure you want to downvote this review?")&&(n.voted=!0,n.downvotes++,$.post("/ajax/reviews.ashx",{action:"downvotereview",id:n.id}))},report:function(n){typeof n=="number"&&(n=this.reviews[n]);confirm("Flag this review as inappropriate?")&&(n.reported=!0,$.post("/ajax/reviews.ashx",{action:"reportreview",id:n.id}))},toDate:function(n){return typeof n=="string"?new Date(n):n},getIconAbbr:function(n){try{n=n.toUpperCase();n=n.replace(/[^A-Z ]/g,"").replace(/\s{2,}/g," ");var t=n[0].toUpperCase(),i=n.split(" ");return i.length>1&&(t+=i[1][0].toUpperCase()),t}catch(r){return"P"}}},computed:{uploadSupport:function(){return window.FileReader&&window.File&&window.FileList&&window.Blob},IMAGE_ADD_ICON:function(){return"data:image/gif;base64,R0lGODlhEAAQAIABAN3d3QAAACH5BAEAAAEALAAAAAAQABAAAAIlhI9pwe2+nmQRAllbpvft8IWdgnAcOXYWpmqt6b2gLE7TZ6N6AQA7"},visible_reviews:function(){return this.reviews.filter(function(n){return n.hide_review==!1||n.hide_review==undefined})},hidden_reviews:function(){return this.reviews.filter(function(n){return n.hide_review===!0})}},watch:{showReviewForm:function(){if(this.hCaptchaInjected)this.hCaptchaInjected=!0;else{var n=document.createElement("script");n.setAttribute("src","https://hcaptcha.com/1/api.js");document.head.appendChild(n)}}},created:function(){var n=this;this.transformResults(this.reviews);this.showPageBoundReviews=!1;this.total_reviews==this.visible_reviews.length&&(this.hasMore=!1);this.reviews.forEach(function(t,i){Vue.set(t,"hide_review",i+1>n.reviews_per_screen)});window.document.body.classList.contains("is-framed")&&(this.showReviewForm=!0)},mounted:function(){function t(n,t){var r=this,u=n.files[0],i=new FileReader;i.onloadend=function(n){var i=n.target.result;r.newReview[t]=i};i.readAsDataURL(u)}var n=this;this.$refs.img1input.addEventListener("change",function(){t.call(n,this,"image1")});this.$refs.img2input.addEventListener("change",function(){t.call(n,this,"image2")});this.$refs.img3input.addEventListener("change",function(){t.call(n,this,"image3")})}})});