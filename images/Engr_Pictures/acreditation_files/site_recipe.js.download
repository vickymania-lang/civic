var __INIT_ONSITE_RECS=function(){function e(e){try{if(e&&e.length)for(var r=0;r<e.length;r++)this.push(e[r])}catch(e){O.log("worker "+e)}}var r,c="Undefined",y=null,p="readonly",t=["executeRule"],j=100,O={log:function(e){},errorSend:function(){this.log(O.failure.message),_c2pResponse.error=O.failure.message},failure:{error:!1,message:""},response:function(e){try{O.log("result =>",e),this.failure.error&&this.errorSend(),e.attribution?_c2pResponse.attribution=e.result:e.error&&!e.error||(_c2pResponse.data=e||{})}catch(e){}}},T={executeFunctionByName:function(e,r){try{for(var t=e.split("."),n=t.pop(),a=0;a<t.length;a++)r=r[t[a]];return r[n].apply(r)}catch(e){return bluecoreSite_debug.d("executeFunctionByName "+e,bluecoreSite_logLevel.error),[]}},convertToObject:function(e){try{if("Object"===this.checkVariableType(e))return e;if("Array"!==this.checkVariableType(e))return null;var r,t={};for(r in e)"Function"!==this.checkVariableType(e[r])&&void 0!==e[r]&&(t[r]=e[r]);return t}catch(e){O.log("convertToObject "+e)}},getObjectValues:function(e){try{var r,t=[];if("Object"!==this.checkVariableType(e))return[];for(r in e)t.push(e[r]);return t}catch(e){O.log("convertToObject "+e)}},validateString:function(e){try{return null!==e&&""!==e&&void 0!==e}catch(e){return!1}},checkVariableType:function(e){try{return Object.prototype.toString.call(e).split(" ")[1].slice(0,-1)}catch(e){return!1}},inheritPredefinedFunction:function(e){try{T.validateKey=e.validateKey,T.trimStr=e.trimStr,T.isJsonString=e.isJsonString,T.includes=e.includes,T.isEmptyObject=e.isEmptyObject,T.mergeObject=e.mergeObject}catch(e){}},cloneObject:function(r){try{if("Object"!==this.checkVariableType(r))return r;var e,t=r.constructor();for(e in r)r.hasOwnProperty(e)&&(t[e]=r[e]);return t}catch(e){return r}},getPriorityAttributes:function(e){try{return e.slice(1,e.length)}catch(e){}}},S={lastDataBycount:function(a,i){return T.validateString(a)?"Number"!==T.checkVariableType(i)?(O.log("lastDataByCount count is not Number Type"),!1):new Promise(function(t,r){try{var e=y.transaction([a],p).objectStore(a),n=[];e.openCursor(null,"prev").onsuccess=function(e){try{var r=e.target.result;r&&0<i?(n.push(r.value),i--,r.continue()):t(n)}catch(e){}}}catch(e){r(null)}}):(O.log("lastDataByCount table is not String Type"),!1)},lastDataBydays:function(u,l,e){var s;return T.validateString(u)?"Number"!==T.checkVariableType(l)?(O.log("lastDataByDays days is not Number Type"),!1):"Number"!==T.checkVariableType(e)?(O.log("lastDataByDays maxLimit is not Number Type"),!1):(s=e||100,new Promise(function(t,r){try{var e=y.transaction([u],p).objectStore(u),n=new Date,a=n.setDate(n.getDate()-l),i=e.index("timestamp"),c=IDBKeyRange.lowerBound(a),o=[];i.openCursor(c,"prev").onsuccess=function(e){try{var r=e.target.result;r&&0<s?(s--,o.push(r.value),r.continue()):t(o)}catch(e){}}}catch(e){r(null)}})):(O.log("lastDataByDays table is not String Type"),!1)}},A=function(a,i){return new Promise(function(e,r){try{"Array"!==T.checkVariableType(a)&&(O.log("extractByAttributeName array is not Array Type"),e(!1)),"Array"!==T.checkVariableType(i)&&(O.log("extractByAttributeName attrArray is not Array Type"),e(!1));var n=0;e(a.map(function(t){return i.map(function(e){var r={};return T.checkVariableType(t[e])!==c?(r[e]=t[e],r):(++n===a.length&&(O.failure.error=!0,O.failure.message=e+" not found in extractByAttributeName"),!1)})}))}catch(e){r(null)}})},k=function(e){try{if(e=T.getObjectValues(e)[0],"Object"!==T.checkVariableType(e))return O.log("getSortedArraySynchronous object is not Object Type"),!1;var r,t=[];for(r in e)t.push([r,e[r]]);return t.sort(function(e,r){return e[1]-r[1]}),[t.pop()[0]]}catch(e){return!1}},V=function(e,r){try{var t,n;return"Array"!==T.checkVariableType(e)?(O.log("uniqueCountByMatchingAttributeSynchronous array is not Array Type"),!1):T.validateString(r)?(t=(e=e.filter(function(e){return T.validateKey(e)})).reduce(function(e,r){return e[r]=T.checkVariableType(e[r])===c?1:e[r]+=1,e},{}),n={},T.checkVariableType(r)!==c?(n[r]=t,n):t):(O.log("uniqueCountByMatchingAttributeSynchronous returnMappedKey is not String Type"),!1)}catch(e){return!1}},x=function(t,n){var a={};return new Promise(function(e,r){try{"Array"!==T.checkVariableType(t)&&(O.log("assignKeyInArray array is not Array Type"),e(!1)),"Array"!==T.checkVariableType(n)&&(O.log("assignKeyInArray array is not Array Type"),e(!1)),t.forEach(function(e){for(var r in n){var t=e[r][n[r]];T.checkVariableType(a[n[r]])===c?T.checkVariableType(t)!==c&&(a[n[r]]=[],a[n[r]].push(t)):T.checkVariableType(t)!==c&&a[n[r]].push(t)}}),e(a)}catch(e){O.log("assignKeyInArray "+e)}})},o=function(e){switch(O.failure={error:!1,message:""},e.recipeName){case"simpleRecipe":try{var r=(c=e.query).table,a=c.type,t=c.value,n=e.returnAttribute,i=j,o=e.supportedObject;return S["lastDataBy"+a](r,t,i).then(function(e){A(e,n).then(function(e){x(e,n).then(function(e){e?O.response({result:e,error:!1,attribution:!1,supportedObject:o}):O.errorSend()})})}),!1}catch(e){return!1}case"mixModeRecipe":try{var c,r=(c=e.query).table,a=c.type,t=c.value,n=e.returnAttribute,o=e.supportedObject,u=e.type,l=T.getPriorityAttributes(n),i=j,s=e.excludeKey||null,y=!0;return null!==s&&(T.includes(s,n)?y=!1:n.push(s)),S["lastDataBy"+a](r,t,i).then(function(e){e?"groupMode"===u||"mixCategories"===u?A(e,n).then(function(e){e?x(e,n).then(function(r){if(r){if("groupMode"===u){var t={},e={};for(c in l){var n=r[l[c]];new Promise(function(e,r){t[l[c]]=k(V(n,l[c])),!1===t[l[c]]&&delete t[l[c]]}),delete r[l[c]]}e.filter=t;var a=T.mergeObject(e,r),i={};-1!==bcQuery.inArray(s,Object.keys(r))&&(i[s]=r[s][0],a=T.mergeObject(a,{excludeKey:T.cloneObject(i)}),y)&&delete a[s]}else if("mixCategories"===u){var c,e={},t={};for(c in l.map(function(e){t[e]=r[e]}),e.filter=t,l)delete r[l[c]];a=T.mergeObject(e,r),i={};-1!==bcQuery.inArray(s,Object.keys(r))&&(i[s]=r[s][0],a=T.mergeObject(a,{excludeKey:T.cloneObject(i)}),y)&&delete a[s]}}else O.errorSend();O.response({result:a,error:T.isEmptyObject(a),attribution:!1,supportedObject:o})}):O.errorSend()}):(O.failure.error=!0,O.failure.message=u+" method not available at this time",O.errorSend()):O.errorSend()}),!1}catch(e){return!1}case"distinctRecipe":try{var p=triggermail.persist.read_prop("distinct_id"),b={},o=e.supportedObject,f=e.returnAttribute[0];p&&(b[f]=new Array(p)),O.response({result:b,error:T.isEmptyObject(b),attribution:!1,supportedObject:o})}catch(e){}case"customFunctionRecipe":try{var b={},o=e.supportedObject,h=T.executeFunctionByName(e.functionName,window),n=e.returnAttribute,l=[],a=e.type,s=e.excludeKey||null,y=null,b={},g={},d={},m={},v=e.query.value,h=h.slice(-1*v);"Array"===T.checkVariableType(h)&&0<h.length?"groupMode"===a||"mixCategories"===a||"all"===a?("all"===a&&(n=Object.keys(h[0])),l=T.getPriorityAttributes(n),A(h,n).then(function(e){e?x(e,n).then(function(r){if(r){if("groupMode"===a){for(var t in l){var n=r[l[t]];new Promise(function(e,r){d[l[t]]=k(V(n,l[t])),!1===d[l[t]]&&delete d[l[t]]}),delete r[l[t]]}m.filter=d,b=T.mergeObject(m,r),-1!==bcQuery.inArray(s,Object.keys(r))&&(g[s]=r[s][0],b=T.mergeObject(b,{excludeKey:T.cloneObject(g)}),y)&&delete b[s]}else if("mixCategories"===a||"all"===a){for(var t in l.map(function(e){d[e]=r[e]}),m.filter=d,l)delete r[l[t]];b=T.mergeObject(m,r),-1!==bcQuery.inArray(s,Object.keys(r))&&(g[s]=r[s][0],b=T.mergeObject(b,{excludeKey:T.cloneObject(g)}),y)&&delete b[s]}}else O.errorSend();O.response({result:b,error:T.isEmptyObject(b),attribution:!1,supportedObject:o})}):O.errorSend()})):(O.failure.error=!0,O.failure.message=a+" type not available at this time",O.errorSend()):(O.failure.error=!0,O.failure.message="FDE function returned empty array or undefined at this time",O.errorSend())}catch(e){}}},n=(e.prototype.push=function(e){try{var r;e&&"Array"===T.checkVariableType(e)&&e.length&&(r=String(e.splice(0,1)),-1!==bcQuery.inArray(r,t)?n[r].apply(n,e):O.log("error no event Fount _c2pServiceInternal"))}catch(e){O.log("worker prototype "+e)}},{executeRule:function(e,r,t,n,a){try{T.inheritPredefinedFunction(a),e.supportedObject=r||{},i=t,c=n,new Promise(function(e,r){try{y=c,e(!0)}catch(e){O.log("error in DB init "+e),r(!0)}}).then(function(){o(e)})}catch(e){O.log("executeRule "+e)}var i,c}});r=window._c2pServiceInternal,window._c2pServiceInternal=new e(r)};